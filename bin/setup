#!/usr/bin/env bash

BASE_DIR="$(basename $PWD)"

# Setup results output
__results="
Results:
"

# Confirm we're installing from the project root
if [[ $BASE_DIR != 'dotfiles' ]]; then
  echo '--- ERROR: Must be in the project root to install. ---' ; exit 1
fi


# Determine if we need to switch to the linux branch
read -rp "Which environment? ([l]inux/[m]ac/[a]bort)? " answer
case ${answer:0:1} in
    l|L|linux )
        echo "Checking out branch: linux"
        git checkout --track origin/linux
        __results+="\n* Switched to linux branch"
    ;;
    m|M|mac )
        echo "Continuing with branch: master"
    ;;
    a|A|abort )
        echo "Aborting setup"
        exit 0
    ;;
    * )
        echo "Continuing with normal setup"
    ;;
esac


# Install dotfiles
readonly MANIFEST='MANIFEST'
readonly LOCAL_DIR="$PWD/local"

while read -r f
do
  # ln -s "$PWD"/"$f" ~/".$f"
  echo "$PWD"/"$f" ~/".$f"
done < $MANIFEST
__results+="\n* Setup symlinks to dotfiles in MANIFEST"

for file in "$LOCAL_DIR"/*; do
  filename="$(basename $file)"
  cp "$file" ~/".$filename"
done
__results+="\n* Copied local config files from dir \"local/\" to $HOME"


# Install TMUX plugin manager
if [ ! -d "$HOME/.tmux/plugins" ]; then
  git clone https://github.com/tmux-plugins/tpm ~/tmux/plugins/tpm
  __results+="\n* Installed Tmux Plugin Manager \"tmux/plugins/tpm\""
fi

# Install Vundle
git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim
vim +PluginInstall +qall
__results+="\n* Installed Vundle and packages listed in \"vim/vimrc.bundles\""


# Prompt user to load new environment
__results+="\n\n ---> ACTION REQUIRED: Reload your env by runing \"source ~/.bashrc\" to complete the install."

echo -e "$__results"
exit 0
