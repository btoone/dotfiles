#!/usr/bin/env bash

# Value of BASE_DIR is "dotfiles". The README instructs the user to run 
# `bin/setup` and errors if called from another location.
BASE_DIR=$(basename "$PWD")

# Setup results output
__preinstall="
=================
   PRE INSTALL
=================

1. Install Homebrew
2. Install packages from Brewfile

    $ brew bundle --global
"

echo -e "$__preinstall"

# Setup results output
__results="
Summary:
"

# Confirm we're installing from the project root
if [[ $BASE_DIR != 'dotfiles' ]]; then
  echo '--- ERROR: Must be in the project root to install. ---' ; exit 1
fi

# Determine if we need to switch to the linux branch
read -rp "Which environment? ([l]inux/[m]ac/[a]bort)? " answer
case ${answer:0:1} in
    l|L|linux )
        echo "Checking out branch: linux"
        git checkout --track origin/linux
        __results+="\n* Switched to linux branch"
    ;;
    m|M|mac )
        echo "Continuing with branch: master"
    ;;
    a|A|abort )
        echo "Aborting setup"
        exit 0
    ;;
    * )
        echo "Continuing with normal setup"
    ;;
esac

# Install dotfiles
readonly MANIFEST='MANIFEST'
readonly LOCAL_DIR="$PWD/local"

while read -r f
do
  ln -sf "$PWD/$f" "$HOME/.$f"
done < "$MANIFEST"
__results+="\n* Created symlink for each dotfiles listed in MANIFEST"

for file in "$LOCAL_DIR"/*; do
  filename=$(basename "$file")
  cp "$file" "$HOME/.$filename"
done
__results+="\n* Copied local config files from dir \"local/\" to $HOME"

# Install TMUX plugin manager
if [ ! -d "$HOME/.tmux/plugins" ]; then
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  __results+="\n* Installed Tmux Plugin Manager \"~/.tmux/plugins/tpm\""
fi

# Vim plugins are managed by vim-plug and installed on first launch

# Initialize mise and install runtimes from tool-versions
if command -v mise &> /dev/null; then
  echo "â†’ Installing mise runtimes from tool-versions..."
  mise install
  __results+="\n* Installed mise runtimes from tool-versions"
else
  __results+="\n* Skipped mise setup (not installed - run 'brew bundle --global' first)"
fi

# Prompt user to load new environment
__results+="
=================
   NEXT STEPS
=================

1. Start a new terminal session (or run 'exec zsh' to reload)
2. In tmux: prefix + I to install plugins
3. In vim: :PlugInstall to install plugins
4. Set terminal font to \"Hack Nerd Font\" for status bar icons
"

echo -e "$__results"
exit 0
